{"version":3,"sources":["../src/module.js"],"names":["CanvasPanelCtrl","DistinctPoints","config","appEvents","kbn","grafanaColors","_","moment","angular","DiscretePanelCtrl","$scope","$injector","$q","data","panelDefaults","display","rowHeight","rowMargin","valueMaps","value","op","text","mappingTypes","name","rangeMaps","from","to","colorMaps","color","tooltip","highlightOnMouseover","shared","sort","metricNameColor","valueTextColor","backgroundColor","lineColor","crosshairColor","textSize","writeLastValue","writeAllValues","writeMetricNames","showLegend","showLegendNames","showLegendValues","showLegendPercent","legendSortBy","defaults","panel","externalPT","events","on","onInitEditMode","bind","onRender","onDataReceived","onDataError","onRefresh","updateColorInfo","onConfigChanged","err","console","log","addEditorTab","editorTabIndex","refresh","x","y","w","h","ctx","context","tempComposition","globalCompositeOperation","tempFillStyle","fillStyle","beginPath","fillRect","fill","_renderDimenstions","rect","wrap","getBoundingClientRect","rows","length","height","width","rectHeight","top","elapsed","range","matrix","forEach","positions","isTimeline","lastBS","point","metric","changes","i","start","xt","Math","max","push","isStacked","legendInfo","ms","selectionPredicates","all","crosshairHover","j","mouse","position","ts","mouseX","row","_selectedMetric","legendItem","_selectedLegendItem","val","_getVal","getPridicate","undefined","down","pn","predicate","_selectionMatrix","rs","r","metricIndex","rectIndex","canvas","_devicePixelRatio","$","css","scale","rowObj","currentX","nextX","getColor","globalAlphaTemp","globalAlpha","LEBELS_PADDING","lineWidth","textBaseline","font","findLength","testLine","substr","measure","measureText","centerV","labelPositionMetricName","labelPositionLastValue","labelPositionValue","textAlign","fillText","_getWidth","cval","xmin","min","xmax","strokeStyle","strokeRect","moveTo","lineTo","stroke","arc","PI","_updateRenderDimensions","_updateSelectionMatrix","_updateCanvasSize","_renderRects","_renderLabels","_renderSelection","_renderCrosshair","dashboard","formatDate","evt","isExternal","time","body","duration","humanize","pageX","pageY","pos","panelRelY","window","innerHeight","clearTT","scrollTop","pX","left","$tooltip","html","place_tt","infos","selectedIndex","Number","isInteger","Error","_getCurrentTimeFormatted","items","_isTooltipOrderReversed","reverse","each","info","seriesName","count","points","Array","isArray","stats","isNumber","map","parseFloat","isNull","isNil","isString","toString","has","colorMap","_colorsPaleteCash","c","letters","split","floor","random","datasource","targets","when","scopedVars","Object","assign","interval","intervalMs","rangeRaw","expandFromQueryS","clone","subtract","format","metricsQuery","panelId","id","renderer","maxDataPoints","resolution","cacheTimeout","query","dataList","type","columns","last","res","add","formatValue","finish","target","datapoints","index","indexOf","splice","cm","m","render","what","randomColor","rangeMap","disp","showLegendCounts","showLegendTime","hassomething","dec","legendPercentDecimals","per","valueFormats","percentunit","event","item","showLegendTooltip","clamp","selected","showTT","hoverPoint","_showSelectionTooltip","_getRowsToHover","js","hovers","hover","_showTimelineTooltips","_showStackedTooltips","where","pt","utc","timeSrv","setTime","_clear","emit","templateUrl"],"mappings":"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","file":"module.js","sourcesContent":["import { CanvasPanelCtrl } from './canvas-panel';\nimport { DistinctPoints } from './distinct-points';\n\nimport config from 'app/core/config';\nimport appEvents from 'app/core/app_events';\nimport kbn from 'app/core/utils/kbn';\nimport grafanaColors from 'app/core/utils/colors';\n\nimport _ from 'lodash';\nimport moment from 'moment';\nimport angular from 'angular';\n\n\nclass DiscretePanelCtrl extends CanvasPanelCtrl {\n\n  constructor($scope, $injector, $q) {\n    super($scope, $injector, $q);\n\n    this.data = null;\n\n    // Set and populate defaults\n    var panelDefaults = {\n      display: 'timeline',\n      rowHeight: 40,\n      rowMargin: 1,\n      valueMaps: [\n        { value: 'null', op: '=', text: 'N/A' }\n      ],\n      mappingTypes: [\n        { name: 'value to text', value: 1 },\n        { name: 'range to text', value: 2 },\n      ],\n      rangeMaps: [\n        { from: 'null', to: 'null', text: 'N/A' }\n      ],\n      colorMaps: [\n        { text: 'N/A', color: '#CCC' }\n      ],\n      tooltip: {\n        highlightOnMouseover: true,\n        shared: true,\n        sort: 0\n      },\n      metricNameColor: '#000000',\n      valueTextColor: '#000000',\n      backgroundColor: 'rgba(128, 128, 128, 0.1)',\n      lineColor: 'rgba(128, 128, 128, 1.0)',\n      crosshairColor: 'rgba(170, 0, 0, 0.80)', // see jquery.flot.crosshair.js\n      textSize: 24,\n      writeLastValue: true,\n      writeAllValues: false,\n      writeMetricNames: false,\n      showLegend: true,\n      showLegendNames: true,\n      showLegendValues: true,\n      showLegendPercent: true,\n      legendSortBy: '-ms'\n    };\n\n    _.defaults(this.panel, panelDefaults);\n    this.externalPT = false;\n\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n    this.events.on('render', this.onRender.bind(this));\n    this.events.on('data-received', this.onDataReceived.bind(this));\n    this.events.on('data-error', this.onDataError.bind(this));\n    this.events.on('refresh', this.onRefresh.bind(this));\n\n    this.updateColorInfo();\n    this.onConfigChanged();\n  }\n\n  onDataError(err) {\n    console.log(\"onDataError\", err);\n  }\n\n  onInitEditMode() {\n    this.addEditorTab('Options', 'public/plugins/natel-discrete-panel/editor.options.html',1);\n    this.addEditorTab('Legend', 'public/plugins/natel-discrete-panel/editor.legend.html',3);\n    this.addEditorTab('Colors', 'public/plugins/natel-discrete-panel/editor.colors.html',4);\n    this.addEditorTab('Mappings', 'public/plugins/natel-discrete-panel/editor.mappings.html', 5);\n    this.editorTabIndex = 1;\n    this.refresh();\n  }\n\n  _drawUnselectRect(x, y, w, h) {\n    var ctx = this.context;\n    var tempComposition = ctx.globalCompositeOperation;\n    var tempFillStyle = ctx.fillStyle;\n\n    ctx.globalCompositeOperation = 'destination-out';\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.5)\";\n    ctx.beginPath();\n    ctx.fillRect(x, y, w, h);\n    ctx.fill();\n\n    ctx.fillStyle = tempFillStyle;\n    ctx.globalCompositeOperation = tempComposition;\n  }\n\n  _updateRenderDimensions() {\n    this._renderDimenstions = { };\n\n    var rect = this._renderDimenstions.rect = this.wrap.getBoundingClientRect();\n    var rows = this._renderDimenstions.rows = this.data.length;\n    var rowHeight = this._renderDimenstions.rowHeight = this.panel.rowHeight;\n    var height = this._renderDimenstions.height = rowHeight * rows - this.panel.rowMargin;\n    var width = this._renderDimenstions.width = rect.width;\n    var rectHeight = this._renderDimenstions.rectHeight = rowHeight - this.panel.rowMargin;\n\n    var top = 0;\n    var elapsed = this.range.to - this.range.from;\n\n    this._renderDimenstions.matrix = [];\n    _.forEach(this.data, metric => {\n      var positions = [];\n\n      if(this.isTimeline) {\n        var lastBS = 0;\n        var point = metric.changes[0];\n        for(var i = 0; i < metric.changes.length; i++) {\n          point = metric.changes[i];\n          if(point.start <= this.range.to) {\n            var xt = Math.max(point.start - this.range.from, 0);\n            var x = (xt / elapsed) * width;\n            positions.push(x);\n          }\n        }\n      }\n      \n      if(this.isStacked) {\n        var point = null;\n        var start = this.range.from;\n        for(var i = 0; i < metric.legendInfo.length; i++) {\n          point = metric.legendInfo[i];\n          var xt = Math.max(start - this.range.from, 0);\n          var x = (xt / elapsed) * width;\n          positions.push(x);\n          start += point.ms;\n        }\n      }\n\n      this._renderDimenstions.matrix.push({\n        y: top,\n        positions: positions\n      });\n\n      top += rowHeight;\n    });\n  }\n\n  _updateSelectionMatrix() {\n    var selectionPredicates = {\n      all: function() { return true; },\n      crosshairHover: function(i, j) {\n        if(j + 1 === this.data[i].changes.length) {\n          return this.data[i].changes[j].start <= this.mouse.position.ts;\n        }\n        return this.data[i].changes[j].start <= this.mouse.position.ts &&\n               this.mouse.position.ts < this.data[i].changes[j + 1].start;\n      },\n      mouseX: function(i, j) {\n        var row = this._renderDimenstions.matrix[i];\n        if(j + 1 === row.positions.length) {\n          return row.positions[j] <= this.mouse.position.x;\n        }\n        return row.positions[j] <= this.mouse.position.x &&\n               this.mouse.position.x < row.positions[j + 1];\n      },\n      metric: function(i) {\n        return this.data[i] === this._selectedMetric;\n      },\n      legendItem: function(i, j) {\n        if(this.data[i] !== this._selectedMetric) {\n          return false;\n        }\n        return this._selectedLegendItem.val === this._getVal(i, j);\n      }\n    };\n\n    function getPridicate() {\n      if(this._selectedLegendItem !== undefined) {\n        return 'legendItem';\n      };\n      if(this._selectedMetric !== undefined) {\n        return 'metric';\n      };\n      if(this.mouse.down !== null) {\n        return 'all';  \n      }\n      if(this.panel.tooltip.highlightOnMouseover && this.mouse.position != null) {\n        if(this.isTimeline) {\n          return 'crosshairHover';\n        }\n        if(this.isStacked) {\n          return 'mouseX';\n        }\n      }\n      return 'all';\n    }\n\n    var pn = getPridicate.bind(this)();\n    var predicate = selectionPredicates[pn].bind(this);\n    this._selectionMatrix = [];\n    for(var i = 0; i < this._renderDimenstions.matrix.length; i++) {\n      var rs = [];\n      var r = this._renderDimenstions.matrix[i];\n      for(var j = 0; j < r.positions.length; j++) {\n        rs.push(predicate(i, j));\n      }\n      this._selectionMatrix.push(rs);\n    }\n  }\n\n  _getVal(metricIndex, rectIndex) {\n    var point = undefined;\n    if(this.isTimeline) { point = this.data[metricIndex].changes[rectIndex]; }\n    if(this.isStacked) { point = this.data[metricIndex].legendInfo[rectIndex]; }\n    return point.val;\n  }\n\n  _getWidth(metricIndex, rectIndex) {\n    var positions = this._renderDimenstions.matrix[metricIndex].positions;\n    if(rectIndex + 1 === positions.length) {\n      return this._renderDimenstions.width - positions[rectIndex];\n    }\n    return positions[rectIndex + 1] - positions[rectIndex];\n  }\n\n  _updateCanvasSize() {\n    this.canvas.width = this._renderDimenstions.width * this._devicePixelRatio;\n    this.canvas.height = this._renderDimenstions.height * this._devicePixelRatio;\n\n    $(this.canvas).css('width', this._renderDimenstions.width + 'px');\n    $(this.canvas).css('height', this._renderDimenstions.height + 'px');\n\n    this.context.scale(this._devicePixelRatio, this._devicePixelRatio);\n  }\n\n  _renderRects() {\n    var matrix = this._renderDimenstions.matrix;\n    var ctx = this.context;\n    _.forEach(this.data, (metric, i) => {\n      var rowObj = matrix[i];\n      for(var j = 0; j < rowObj.positions.length; j++) {\n        var currentX = rowObj.positions[j];\n        var nextX = this._renderDimenstions.width;\n        if(j + 1 !== rowObj.positions.length) {\n          nextX = rowObj.positions[j + 1];\n        }\n        ctx.fillStyle = this.getColor(this._getVal(i, j));\n        var globalAlphaTemp = ctx.globalAlpha;\n        if(!this._selectionMatrix[i][j]) {\n          ctx.globalAlpha = 0.3;\n        }\n        ctx.fillRect(\n          currentX, matrix[i].y,\n          nextX - currentX, this._renderDimenstions.rectHeight\n        );\n        ctx.globalAlpha = globalAlphaTemp;\n      }\n    });\n  }\n\n  _renderLabels() {\n\n    const LEBELS_PADDING = 8;\n    var ctx = this.context;\n    ctx.lineWidth = 1;\n    ctx.textBaseline = 'middle';\n    ctx.font = this.panel.textSize + 'px \"Open Sans\", Helvetica, Arial, sans-serif';\n\n    function findLength(text, width) {\n      var length = 1;\n      for(; length < text.length + 1; length++) {\n        var testLine = text.substr(0, length);\n        var measure = ctx.measureText(testLine);\n        if(measure.width > width) {\n          break;\n        }\n      }\n\n      return text.substr(0, length - 1);\n    }\n\n    _.forEach(this.data, (metric, i) => {\n      var { y, positions } = this._renderDimenstions.matrix[i];\n      var rectHeight = this._renderDimenstions.rectHeight;\n\n      var centerV = y + (rectHeight / 2);\n      var labelPositionMetricName = y + rectHeight - this.panel.textSize / 2 - 3;\n      var labelPositionLastValue  = y + rectHeight - this.panel.textSize / 2 - 3;\n      var labelPositionValue      = y + this.panel.textSize / 2 + 3;\n\n      if(this.mouse.position == null) {\n        if(this.panel.writeMetricNames) {\n          ctx.fillStyle = this.panel.metricNameColor;\n          ctx.textAlign = 'left';\n          ctx.fillText(metric.name, LEBELS_PADDING, labelPositionMetricName);\n        }\n        if(this.panel.writeLastValue) {\n          var val = this._getVal(i, positions.length - 1);\n          ctx.fillStyle = this.panel.valueTextColor;\n          ctx.textAlign = 'right';\n          ctx.fillText(val, this._renderDimenstions.width - LEBELS_PADDING, labelPositionLastValue);\n        }\n      }\n      \n      ctx.fillStyle = this.panel.valueTextColor;\n      ctx.textAlign = 'left';\n      for(var j = 0; j < positions.length; j++) {\n        var val = this._getVal(i, j);\n        var width = this._getWidth(i, j);\n        var cval = findLength(val, width - LEBELS_PADDING * 2);\n        ctx.fillText(cval, positions[j] + LEBELS_PADDING, labelPositionValue);\n      }\n\n    });\n\n  }\n\n  _renderSelection() {\n    if(this.mouse.down === null) {\n      return;\n    }\n    if(this.mouse.position === null) {\n      return;\n    }\n    if(!this.isTimeline) {\n      return;\n    }\n\n    var ctx = this.context;\n    var height = this._renderDimenstions.height;\n\n    var xmin = Math.min(this.mouse.position.x, this.mouse.down.x);\n    var xmax = Math.max(this.mouse.position.x, this.mouse.down.x);\n\n    ctx.fillStyle = \"rgba(110, 110, 110, 0.5)\";\n    ctx.strokeStyle=\"rgba(110, 110, 110, 0.5)\";\n    ctx.beginPath();\n    ctx.fillRect(xmin, 0, xmax - xmin, height);\n    ctx.strokeRect(xmin, 0, xmax - xmin, height);\n  }\n\n  _renderCrosshair() {\n    if(this.mouse.down != null) {\n      return;\n    }\n    if(this.mouse.position === null) {\n      return;\n    }\n    if(!this.isTimeline) {\n      return;\n    }\n\n    var ctx = this.context;\n    var rows = this.data.length;\n    var rowHeight = this.panel.rowHeight;\n    var height = this._renderDimenstions.height;\n\n    ctx.beginPath();\n    ctx.moveTo(this.mouse.position.x, 0);\n    ctx.lineTo(this.mouse.position.x, height);\n    ctx.strokeStyle = this.panel.crosshairColor;\n    ctx.lineWidth = 1;\n    ctx.stroke();\n\n    if(this.externalPT && rows > 1) {\n      ctx.beginPath();\n      ctx.arc(this.mouse.position.x, this.mouse.position.y, 3, 0, 2 * Math.PI, false);\n      ctx.fillStyle = this.panel.crosshairColor;\n      ctx.fill();\n      ctx.lineWidth = 1;\n    } \n  }\n\n  onRender() {\n    if(this.data == null || !(this.context)) {\n      return;\n    }\n    this._updateRenderDimensions();\n    this._updateSelectionMatrix();\n    this._updateCanvasSize();\n    this._renderRects();\n    this._renderLabels();\n    this._renderSelection();\n    this._renderCrosshair();\n  }\n\n  get _isTooltipOrderReversed() {\n    return this.panel.tooltip.sort === 2;\n  }\n\n  _getCurrentTimeFormatted() {\n    // Format might be idfferent \n    // see https://github.com/grafana/grafana/blob/32f9a42d5e931be549ff9f169468b404af9a6b21/public/app/plugins/panel/graph/graph_tooltip.js#L212\n    return this.dashboard.formatDate(moment(this.mouse.position.ts), 'YYYY-MM-DD HH:mm:ss.SSS');\n  }\n\n  _showSelectionTooltip(evt, point, isExternal) {\n    \n    var from = point.start;\n    var to = point.start + point.ms;\n    var time = point.ms;\n    var val = point.val;\n\n    var body = '<div class=\"graph-tooltip-time\">' + val + '</div>';\n\n    body += \"<center>\"\n    body += this.dashboard.formatDate(moment(from));\n    body += \" to \";\n    body += this.dashboard.formatDate(moment(to));\n    body += \" (\" + moment.duration(time).humanize() + \")\";\n    body += \"</center>\"\n    \n    var pageX = 0;\n    var pageY = 0;\n    if(isExternal) {\n      var rect = this.canvas.getBoundingClientRect();\n      pageY = rect.top + (evt.pos.panelRelY * rect.height);\n      if(pageY < 0 || pageY > $(window).innerHeight()) {\n        // Skip Hidden tooltip\n        this.clearTT();\n        return;\n      }\n      pageY += $(window).scrollTop();\n\n      var elapsed = this.range.to - this.range.from;\n      var pX = (evt.pos.x - this.range.from) / elapsed;\n      pageX = rect.left + (pX * rect.width);\n    } else {\n      pageX = evt.evt.pageX;\n      pageY = evt.evt.pageY;\n    }\n\n    this.$tooltip.html(body).place_tt(pageX + 20, pageY + 5);\n  };\n\n  _showStackedTooltips(pos, infos, selectedIndex) {\n\n    if(!Number.isInteger(selectedIndex)) {\n      throw new Error('selectedIndex must integer');\n    }\n\n    var body = `<div class=\"graph-tooltip-time\"> ${this._getCurrentTimeFormatted()} </div>`;\n\n    var items = infos;\n    if(this._isTooltipOrderReversed) {\n      _.reverse(items);\n    }\n    _.each(items, (info, i) => {\n\n      var color = this.getColor(info.val);\n      var seriesName = this.data[i].name;\n\n      body += `\n      <div \n        class=\"\n          graph-tooltip-list-item \n          ${i == selectedIndex ? 'graph-tooltip-list-item--highlight' : ''}\n        \"\n      >\n        <div class=\"graph-tooltip-series-name\">\n          <i class=\"fa fa-minus\" style=\"color:${color}\"></i>\n          ${seriesName}: ${info.val}\n          (${info.count})\n        </div>\n        <div class=\"graph-tooltip-value\">\n          ${moment.duration(info.ms).humanize()}\n        </div>\n      </div>\n      `;\n    });\n\n    this.$tooltip.html(body).place_tt(pos.pageX + 20, pos.pageY);\n  }\n\n  _showTimelineTooltips(evt, points, selectedIndex, isExternal) {\n\n    if(!Array.isArray(points)) {\n      throw new Error('Not array provided');\n    }\n\n    if(!Number.isInteger(selectedIndex)) {\n      throw new Error('selectedIndex must be integer');\n    }\n\n    var body = `<div class=\"graph-tooltip-time\"> ${this._getCurrentTimeFormatted()} </div>`;\n\n    var items = points;\n    if(this._isTooltipOrderReversed) {\n      _.reverse(items);\n    }\n    \n    _.each(items, (point, i) => {\n\n      var from = point.start;\n      var to = point.start + point.ms;\n      var time = point.ms;\n      var val = point.val;\n      var seriesName = this.data[i].name;\n\n      var color = this.getColor(val);\n\n      body += `\n      <div \n        class=\"\n          graph-tooltip-list-item \n          ${i == selectedIndex ? 'graph-tooltip-list-item--highlight' : ''}\n        \"\n      >\n        <div class=\"graph-tooltip-series-name\">\n          <i class=\"fa fa-minus\" style=\"color:${color}\"></i>\n          ${seriesName}: ${val}\n        </div>\n        <div class=\"graph-tooltip-value\">\n          ${this.dashboard.formatDate(moment(from))}\n          to\n          ${this.dashboard.formatDate(moment(to))}\n          (${moment.duration(time).humanize()});\n        </div>\n      </div>\n      `;\n    });\n    \n    var pageX = 0;\n    var pageY = 0;\n    if(isExternal) {\n      var rect = this.canvas.getBoundingClientRect();\n      pageY = rect.top + (evt.pos.panelRelY * rect.height);\n      if(pageY < 0 || pageY > $(window).innerHeight()) {\n        // Skip Hidden tooltip\n        this.clearTT();\n        return;\n      }\n      pageY += $(window).scrollTop();\n\n      var elapsed = this.range.to - this.range.from;\n      var pX = (evt.pos.x - this.range.from) / elapsed;\n      pageX = rect.left + (pX * rect.width);\n    } else {\n      pageX = evt.evt.pageX;\n      pageY = evt.evt.pageY;\n    }\n\n    this.$tooltip.html(body).place_tt(pageX + 20, pageY + 5);\n\n  }\n\n  showLegendTooltip(pos, info) {\n    var body = '<div class=\"graph-tooltip-time\">'+ info.val +'</div>';\n\n    body += \"<center>\";\n    if(info.count > 1) {\n      body += info.count + \" times<br/>\";\n    }\n    body += moment.duration(info.ms).humanize();\n    if(info.count > 1) {\n      body += \"<br/>total\";\n    }\n    body += \"</center>\"\n\n    this.$tooltip.html(body).place_tt(pos.pageX + 20, pos.pageY);\n  }\n\n  formatValue(val, stats) {\n\n    if(_.isNumber(val) && this.panel.rangeMaps) {\n      for (var i = 0; i < this.panel.rangeMaps.length; i++) {\n        var map = this.panel.rangeMaps[i];\n\n        // value/number to range mapping\n        var from = parseFloat(map.from);\n        var to = parseFloat(map.to);\n        if (to >= val && from <= val) {\n          return map.text;\n        }\n      }\n    }\n\n    var isNull = _.isNil(val);\n    if(!isNull && !_.isString(val)) {\n      val = val.toString(); // convert everything to a string\n    }\n\n    for (var i = 0; i < this.panel.valueMaps.length; i++) {\n      var map = this.panel.valueMaps[i];\n      // special null case\n      if (map.value === 'null') {\n        if (isNull) {\n          return map.text;\n        }\n        continue;\n      }\n\n      if(val == map.value) {\n        return map.text;\n      }\n    }\n\n    if(isNull) {\n      return \"null\";\n    }\n    return val;\n  }\n\n  getColor(val) {\n    if(_.has(this.colorMap, val)) {\n      return this.colorMap[val];\n    }\n    if(this._colorsPaleteCash[val] === undefined) {\n      var c = grafanaColors[this._colorsPaleteCash.length % grafanaColors.length];\n      this._colorsPaleteCash[val] = c;\n      this._colorsPaleteCash.length++;\n    }\n    return this._colorsPaleteCash[val];\n  }\n\n  randomColor() {\n    var letters = 'ABCDE'.split('');\n    var color = '#';\n    for (var i = 0; i < 3; i++) {\n      color += letters[Math.floor(Math.random() * letters.length)];\n    }\n    return color;\n  }\n\n  // Copied from Metrics Panel, only used to expand the 'from' query\n  issueQueries(datasource) {\n    this.datasource = datasource;\n\n    if (!this.panel.targets || this.panel.targets.length === 0) {\n      return this.$q.when([]);\n    }\n\n    // make shallow copy of scoped vars,\n    // and add built in variables interval and interval_ms\n    var scopedVars = Object.assign({}, this.panel.scopedVars, {\n      \"__interval\":     {text: this.interval,   value: this.interval},\n      \"__interval_ms\":  {text: this.intervalMs, value: this.intervalMs},\n    });\n\n    var range = this.range;\n    var rangeRaw = this.rangeRaw;\n    if(this.panel.expandFromQueryS > 0) {\n      range = {\n        from: this.range.from.clone(),\n        to: this.range.to\n      };\n      range.from.subtract( this.panel.expandFromQueryS, 's' );\n\n      rangeRaw = {\n        from: range.from.format(),\n        to: this.rangeRaw.to\n      };\n    }\n\n    var metricsQuery = {\n      panelId: this.panel.id,\n      range: range,\n      rangeRaw: rangeRaw,\n      interval: this.interval,\n      intervalMs: this.intervalMs,\n      targets: this.panel.targets,\n      format: this.panel.renderer === 'png' ? 'png' : 'json',\n      maxDataPoints: this.resolution,\n      scopedVars: scopedVars,\n      cacheTimeout: this.panel.cacheTimeout\n    };\n\n    return datasource.query(metricsQuery);\n  }\n\n  onDataReceived(dataList) {\n    $(this.canvas).css('cursor', 'pointer');\n\n    var data = [];\n    _.forEach(dataList, metric => {\n      if(metric.type === 'table') {\n        if(metric.columns[0].type !== 'time') {\n          throw 'Expected a time column from the table format';\n        }\n\n        var last = null;\n        for(var i = 1; i < metric.columns.length; i++) {\n          var res = new DistinctPoints(metric.columns[i].text);\n          for(var j = 0; j < metric.rows.length; j++) {\n            var row = metric.rows[j];\n            res.add(row[0], this.formatValue(row[i]));\n          }\n          res.finish(this);\n          data.push(res);\n        }\n      } else {\n        var res = new DistinctPoints(metric.target);\n        _.forEach(metric.datapoints, point => {\n          res.add( point[1], this.formatValue(point[0]) );\n        });\n        res.finish(this);\n        data.push(res);\n      }\n    });\n    this.data = data;\n\n    this.onRender();\n  }\n\n  removeColorMap(map) {\n    var index = _.indexOf(this.panel.colorMaps, map);\n    this.panel.colorMaps.splice(index, 1);\n    this.updateColorInfo();\n  };\n\n  updateColorInfo() {\n    var cm = {};\n    for(var i = 0; i < this.panel.colorMaps.length; i++) {\n      var m = this.panel.colorMaps[i];\n      if(m.text) {\n        cm[m.text] = m.color;\n      }\n    }\n    this.colorMap = cm;\n\n    this._colorsPaleteCash = {};\n    this._colorsPaleteCash.length = 0;\n    this.render();\n  }\n\n  addColorMap(what) {\n    if(what == 'curent') {\n      _.forEach(this.data, (metric) => {\n        if(metric.legendInfo) {\n          _.forEach(metric.legendInfo, info => {\n            if(!_.has(info.val)) {\n              this.panel.colorMaps.push({text: info.val, color: this.getColor(info.val) });\n            }\n          });\n        }\n      });\n    }\n    else {\n      this.panel.colorMaps.push({text: '???', color: this.randomColor() });\n    }\n    this.updateColorInfo();\n  }\n\n  removeValueMap(map) {\n    var index = _.indexOf(this.panel.valueMaps, map);\n    this.panel.valueMaps.splice(index, 1);\n    this.render();\n  };\n\n  addValueMap() {\n    this.panel.valueMaps.push({value: '', op: '=', text: '' });\n  }\n\n  removeRangeMap(rangeMap) {\n    var index = _.indexOf(this.panel.rangeMaps, rangeMap);\n    this.panel.rangeMaps.splice(index, 1);\n    this.render();\n  };\n\n  addRangeMap() {\n    this.panel.rangeMaps.push({ from:'', to: '', text:'' });\n  }\n\n  onConfigChanged() {\n    this.isTimeline = this.panel.display == 'timeline';\n    this.isStacked = this.panel.display == 'stacked';\n    this.render();\n  }\n\n  getLegendDisplay(info, metric) {\n    var disp = info.val;\n    if(this.panel.showLegendPercent || this.panel.showLegendCounts || this.panel.showLegendTime) {\n      disp += \" (\";\n      var hassomething = false;\n      if(this.panel.showLegendTime) {\n        disp += moment.duration(info.ms).humanize();\n        hassomething = true;\n      }\n\n      if(this.panel.showLegendPercent) {\n        if(hassomething) {\n          disp += \", \";\n        }\n\n        var dec = this.panel.legendPercentDecimals;\n        if(_.isNil(dec)) {\n          if(info.per>.98 && metric.changes.length>1) {\n            dec = 2;\n          } else if(info.per < 0.02) {\n            dec = 2;\n          } else {\n            dec = 0;\n          }\n        }\n        disp += kbn.valueFormats.percentunit(info.per, dec);\n        hassomething = true;\n      }\n\n      if(this.panel.showLegendCounts) {\n        if(hassomething) {\n          disp += \", \";\n        }\n        disp += info.count + \"x\";\n      }\n      disp += \")\";\n    }\n    return disp;\n  }\n\n  selectLegendMetric(event, metric) {\n    this._selectedMetric = metric;\n    this.render();\n  }\n\n  selectLegendItem(event, item, metric) {\n    this.showLegendTooltip(event, item);\n    this._selectedMetric = metric;\n    this._selectedLegendItem = item;\n    this.render();\n  }\n\n  deselectLegend() {\n    this._selectedMetric = undefined;\n    this._selectedLegendItem = undefined;\n    this.clearTT();\n    this.render();\n  }\n\n  //------------------\n  // Mouse Events\n  //------------------\n\n  _getRowsToHover() {\n    var j = Math.floor(this.mouse.position.y / this.panel.rowHeight);\n    j = _.clamp(j, 0, this.data.length - 1);\n    var res = {\n      items: undefined,\n      selected: undefined\n    };\n\n    if(this.panel.tooltip.shared) {\n      res.items = _.range(0, this.data.length);\n      res.selected = j;\n    } else {\n      res.items = [j];\n      res.selected = 0;\n    }\n\n    return res;\n  }\n\n  onGraphHover(evt, showTT, isExternal) {\n    this.externalPT = isExternal;\n    if(!this.data) {\n      this.clearTT();\n      this.onRender();\n      return;\n    }\n\n    if(this.mouse.down != null) {\n      var from = Math.min(this.mouse.down.ts, this.mouse.position.ts);\n      var to   = Math.max(this.mouse.down.ts, this.mouse.position.ts);\n      var time = to - from;\n      this.hoverPoint = { start: from, ms: time, val: \"Zoom To:\" };\n\n      this._showSelectionTooltip(evt, this.hoverPoint, isExternal);\n      this.onRender();\n      return;\n    }\n\n    if(!showTT) {\n      this.onRender();\n      return;\n    }\n    \n    var { items: js, selected } = this._getRowsToHover();\n    \n    // TODO: use this._renderDimenstions for optimozation\n    if(this.isTimeline) {\n      var hovers = [];\n      _.each(js, j => {\n        var hover = this.data[j].changes[0];\n        for(var i = 0; i < this.data[j].changes.length; i++) {\n          if(this.data[j].changes[i].start > this.mouse.position.ts) {\n            break;\n          }\n          hover = this.data[j].changes[i];\n        }\n        hovers.push(hover);\n      });\n      \n      this._showTimelineTooltips(evt, hovers, selected, isExternal);\n      this.onRender();\n      return;\n    }\n\n    if(!isExternal && this.panel.display == 'stacked') {\n      var hovers = [];\n      _.each(js, j => {\n        var hover = this.data[j].legendInfo[0];\n        for(var i = 0; i < this.data[j].legendInfo.length; i++) {\n          if(this.data[j].legendInfo[i].x > this.mouse.position.x) {\n            break;\n          }\n          hover = this.data[j].legendInfo[i];\n        }\n        hovers.push(hover);\n      });\n\n      this._showStackedTooltips(evt.evt, hovers, selected);\n      this.onRender();\n      return;\n    }\n\n  }\n\n  onMouseClicked(where) {\n    var pt = this.hoverPoint;\n    if(pt && pt.start) {\n      var range = { from: moment.utc(pt.start), to: moment.utc(pt.start + pt.ms) };\n      this.timeSrv.setTime(range);\n      this._clear();\n    }\n  }\n\n  onMouseSelectedRange(range) {\n    this.timeSrv.setTime(range);\n    this._clear();\n  }\n\n  _clear() {\n    this.hoverPoint = null;\n    this.mouse.position = null;\n    this.mouse.down = null;\n    $(this.canvas).css('cursor', 'wait');\n    appEvents.emit('graph-hover-clear');\n    this.render();\n  }\n}\n\nDiscretePanelCtrl.templateUrl = 'module.html';\n\nexport { DiscretePanelCtrl as PanelCtrl };\n"]}